{% extends 'property/create_edit/base.html' %}

{% load static %}

{% block forms %}
    {% include 'property/create_edit/components/form_1.html' %}
    {% include 'property/create_edit/components/form_2.html' %}
    {% include 'property/create_edit/components/form_3.html' %}
    {% include 'property/create_edit/components/form_4.html' %}
    {% include 'property/create_edit/components/form_5.html' %}
    {% include 'property/create_edit/components/form_6.html' %}
    {% include 'property/create_edit/components/form_7.html' %}
    {% include 'property/create_edit/components/form_8.html' %}
    {% include 'property/create_edit/components/form_9.html' %}
    {% include 'property/create_edit/components/form_10.html' %}
    {% include 'property/create_edit/components/form_11.html' %}
    {% include 'property/create_edit/components/form_12.html' %}

{% endblock %}

{% block form_script_post %}
    <script>
        // Form 9 - User Image upload
        Dropzone.autoDiscover = false;
        $("div#profile-img-dropzone").dropzone({
            url: "/file/post",
            paramName: "image",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    </script>
    <script>
        // Form 5 - House image upload
        $("div#house-img-dropzone").dropzone({
            url: "{% url 'house:add_house_images' house_uuid=house.uuid %}",
            paramName: "image",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        $('a[id^="delete-image-"]').click(function (e) {
            e.preventDefault();
            var form_num = $(this).attr("id").split('-')[2];
            $('#thumbnail-container-' + form_num).hide();
            $('#id_images-form-' + form_num + '-DELETE').prop('checked', true);
        });

        $('a[id^="set-thumbnail-"]').click(function (e) {
            e.preventDefault();
            var form_num = $(this).attr("id").split('-')[2];
            $('#id_images-form-' + form_num + '-is_thumbnail').prop('checked', true);
            check_thumbnail_highlight(form_num);
            $('#thumbnail-container-' + form_num).addClass('highlight');

        });

    </script>
    <script>
        // Form 2 - Availability Form
        $('.delete-availability-btn-prev').on('click', function () {
            var id = this.id.split('-').pop();
            $('#availability-list-' + id).css("display", "none");
            $('div[id^="id_availability-form-"][id$="-DELETE"]').prop("checked", true);
        });


        var curr_availability_form = {{ availability_formset.initial_form_count }};
        var total_availability_form = {{ availability_formset.total_form_count }};
        var calendar_feedback = $('#calendar-invalid-feedback-manual');
        $('#add-dates').click(function () {
            calendar_feedback.text();
            var date_arr = pickmeup('#availability-calendar').get_date(true);
            var date_arr_cal = pickmeup('#availability-calendar').get_date(false);
            var date_arr_input = pickmeup('#availability-calendar').get_date('Y-m-d');
            if (date_arr.length > 0) {
                var time_diff = 2332800000; // 27 days in seconds
                if ((date_arr_cal[1].getTime() - date_arr_cal[0].getTime()) > time_diff) {

                    $("#availability-list-" + curr_availability_form).css("display", "block");
                    $('#availability-form-start-date-' + curr_availability_form).text(date_arr[0]);
                    $('#availability-form-end-date-' + curr_availability_form).text(date_arr[1]);
                    $('#id_availability-form-' + curr_availability_form + '-dates_0').val(date_arr_input[0]);
                    $('#id_availability-form-' + curr_availability_form + '-dates_1').val(date_arr_input[1]);

                    curr_availability_form += 1;

                    if (curr_availability_form >= total_availability_form) {
                        $('#id_main-form-submit').prop('checked', true);
                        $('#id_main-form-exit').prop('checked', false);
                        $('#id_main-form-list_now').prop('checked', false);
                        window.removeEventListener("beforeunload", confirm_leave);
                        $('#main_form').submit();
                    }
                }
                else {
                    console.log("Error in dates");
                    calendar_feedback.text('Minimum length of stay allowed is more than or equal to 28 days.')
                }
            }
        });

        $('#clear-dates').click(function () {
            pickmeup('#availability-calendar').clear();
        });

    </script>

{% endblock %}